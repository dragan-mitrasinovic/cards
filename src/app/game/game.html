<div class="block min-h-screen p-4">
  <header class="flex justify-between items-center pb-4 border-b border-gray-200 mb-8">
    <h1 class="m-0 text-2xl font-bold">Cards</h1>
    <div class="flex items-center gap-3">
      @if (gameState.roomCode()) {
        <span class="font-mono bg-gray-100 px-3 py-1 rounded text-sm tracking-wider">{{ gameState.roomCode() }}</span>
        <button
          (click)="copyLink()"
          class="px-3 py-1 text-sm bg-blue-50 text-blue-600 rounded hover:bg-blue-100"
          title="Copy shareable link"
        >
          Copy Link
        </button>
      }
      <span
        class="inline-block w-3 h-3 rounded-full"
        [class.bg-green-500]="ws.status() === 'connected'"
        [class.bg-yellow-400]="ws.status() === 'connecting'"
        [class.bg-red-500]="ws.status() === 'disconnected'"
        [title]="ws.status()"
      ></span>
    </div>
  </header>

  @if (needsJoin()) {
    <!-- Shareable link join form -->
    <div class="flex justify-center items-center min-h-[300px]">
      <div class="w-full max-w-xs">
        <h2 class="text-xl font-semibold mb-4 text-center">Join Game</h2>
        <p class="text-gray-500 text-sm mb-4 text-center">Room: <span class="font-mono">{{ roomId() }}</span></p>

        @if (joinError()) {
          <div class="mb-4 px-3 py-2 bg-red-50 border border-red-200 rounded-md text-red-700 text-sm">
            {{ joinError() }}
          </div>
        }

        <div class="mb-4">
          <label for="join-name" class="block mb-2 font-medium text-sm">Your Name</label>
          <input
            id="join-name"
            type="text"
            [(ngModel)]="joinName"
            placeholder="Enter your name"
            maxlength="20"
            (keydown.enter)="joinRoom()"
            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
          />
        </div>
        <button
          (click)="joinRoom()"
          [disabled]="!joinName.trim()"
          class="w-full px-6 py-2 bg-blue-500 text-white rounded-md font-medium hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Join
        </button>
      </div>
    </div>
  } @else if (!gameState.partnerName()) {
    <!-- Waiting for partner -->
    <div class="flex flex-col justify-center items-center min-h-[300px] border-2 border-dashed border-gray-300 rounded-lg text-gray-500">
      <p class="text-lg mb-2">Waiting for your partner to joinâ€¦</p>
      <p class="text-sm">Share the room code <span class="font-mono font-semibold">{{ gameState.roomCode() }}</span> or use the link above</p>
    </div>
  } @else {
    <!-- Both players are in the room -->
    @if (gameState.phase() === 'turn_order_pick') {
      <div class="flex flex-col items-center min-h-[300px] justify-center">
        @if (partnerDisconnected()) {
          <p class="text-yellow-600 mb-2">{{ gameState.partnerName() }} disconnected</p>
        } @else {
          <app-turn-order-pick />
        }

        <!-- Hand preview -->
        <div class="mt-6 pt-4 border-t border-gray-200 w-full">
          <p class="text-sm text-gray-500 text-center mb-2">Your hand</p>
          <app-hand />
        </div>
      </div>
    } @else if (gameState.phase() === 'placement') {
      <div class="placement-phase">
        <!-- Player bar -->
        <div class="flex items-center justify-between px-4 py-2 bg-gray-50 rounded-lg mb-4">
          <div class="flex items-center gap-4">
            <span class="font-semibold" [class.text-blue-600]="gameState.isMyTurn()">{{ gameState.playerName() }}</span>
            <span class="text-gray-400">&amp;</span>
            <span class="font-semibold" [class.text-blue-600]="!gameState.isMyTurn()">{{ gameState.partnerName() }}</span>
          </div>
          <div class="flex items-center gap-4 text-sm text-gray-500">
            @if (gameState.isMyTurn()) {
              <span class="text-blue-600 font-medium">Your turn</span>
            } @else {
              <span>Waiting for {{ gameState.partnerName() }}â€¦</span>
            }
            @if (!gameState.passUsed()[gameState.playerNumber() - 1]) {
              <button
                (click)="pass()"
                [disabled]="!gameState.isMyTurn()"
                class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Pass
              </button>
            } @else {
              <span class="text-gray-400 text-xs">Pass used</span>
            }
          </div>
        </div>

        <!-- Board -->
        <app-board
          [selectedCardIndex]="selectedCardIndex()"
          (slotPlace)="onSlotPlace($event)"
          (slotPeek)="peek($event)"
        />

        <!-- Hand -->
        <div class="mt-4 pt-4 border-t border-gray-200">
          <p class="text-sm text-gray-500 text-center mb-2">Your hand</p>
          <app-hand
            [selectedIndex]="selectedCardIndex()"
            (cardSelected)="selectCard($event)"
          />
        </div>
      </div>
    } @else if (gameState.phase() === 'swap') {
      <div class="swap-phase">
        <!-- Player bar -->
        <div class="flex items-center justify-between px-4 py-2 bg-gray-50 rounded-lg mb-4">
          <div class="flex items-center gap-4">
            <span class="font-semibold">{{ gameState.playerName() }}</span>
            <span class="text-gray-400">&amp;</span>
            <span class="font-semibold">{{ gameState.partnerName() }}</span>
          </div>
          <div class="flex items-center gap-4 text-sm text-gray-500">
            <span class="text-purple-600 font-medium">Swap Phase</span>
          </div>
        </div>

        @if (gameState.swapPending()) {
          <!-- A swap has been suggested, waiting for response -->
          <div class="flex flex-col items-center gap-4 mb-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
            @if (gameState.swapSuggester() === gameState.playerNumber()) {
              <p class="text-purple-700 font-medium">You suggested swapping the highlighted cards</p>
              <p class="text-sm text-gray-500">Waiting for {{ gameState.partnerName() }} to respondâ€¦</p>
            } @else {
              <p class="text-purple-700 font-medium">{{ gameState.partnerName() }} wants to swap the highlighted cards</p>
              <div class="flex gap-3">
                <button
                  (click)="respondSwap(true)"
                  class="px-4 py-2 bg-green-500 text-white rounded-md font-medium hover:bg-green-600"
                >
                  Accept
                </button>
                <button
                  (click)="respondSwap(false)"
                  class="px-4 py-2 bg-red-500 text-white rounded-md font-medium hover:bg-red-600"
                >
                  Reject
                </button>
              </div>
            }
          </div>
        } @else if (gameState.isMyTurn()) {
          <!-- My turn to suggest a swap -->
          <div class="flex flex-col items-center gap-2 mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <p class="text-blue-700 font-medium">Your turn to suggest a swap</p>
            <p class="text-sm text-gray-500">Click any two cards on the board, or skip</p>
            @if (selectedSwapSlots().length === 1) {
              <p class="text-sm text-blue-600">Selected slot {{ selectedSwapSlots()[0] + 1 }} â€” now click another card</p>
            }
            <button
              (click)="skipSwap()"
              class="mt-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-md font-medium hover:bg-gray-300"
            >
              Skip Swap
            </button>
          </div>
        } @else {
          <!-- Waiting for partner to suggest -->
          <div class="flex flex-col items-center gap-2 mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <p class="text-gray-600 font-medium">Waiting for {{ gameState.partnerName() }} to suggest a swapâ€¦</p>
          </div>
        }

        <!-- Board -->
        <app-board
          [selectedCardIndex]="-1"
          [swapMode]="gameState.isMyTurn() && !gameState.swapPending()"
          [selectedSwapSlots]="gameState.swapPending() ? (gameState.swapSlots() ?? []) : selectedSwapSlots()"
          (slotPlace)="onSwapSlotClick($event)"
          (slotPeek)="onSwapSlotClick($event)"
        />
      </div>
    } @else if (gameState.phase() === 'reveal') {
      <div class="reveal-phase">
        <!-- Player bar -->
        <div class="flex items-center justify-between px-4 py-2 bg-gray-50 rounded-lg mb-4">
          <div class="flex items-center gap-4">
            <span class="font-semibold">{{ gameState.playerName() }}</span>
            <span class="text-gray-400">&amp;</span>
            <span class="font-semibold">{{ gameState.partnerName() }}</span>
          </div>
          <div class="flex items-center gap-4 text-sm">
            <span class="text-amber-600 font-medium">Reveal Phase</span>
            @if (gameState.totalRevealCards() > 0) {
              <span class="text-gray-500">{{ gameState.revealedCount() }} / {{ gameState.totalRevealCards() }}</span>
            }
          </div>
        </div>

        <!-- Status message -->
        <div class="flex flex-col items-center gap-2 mb-4 p-4 bg-amber-50 rounded-lg border border-amber-200">
          @if (gameState.revealedCount() < gameState.totalRevealCards()) {
            <p class="text-amber-700 font-medium">Revealing cardsâ€¦</p>
            <p class="text-sm text-gray-500">Cards are revealed from left to right</p>
          } @else {
            <p class="text-amber-700 font-medium">All cards revealed!</p>
          }
        </div>

        <!-- Board -->
        <app-board
          [selectedCardIndex]="-1"
          [revealMode]="true"
        />
      </div>
    } @else if (gameState.phase() === 'game_over') {
      <div class="game-over-phase">
        <!-- Result banner -->
        @if (gameState.gameResult(); as result) {
          <div class="flex flex-col items-center gap-4 mb-6 p-8 rounded-lg border-2"
            [class.bg-green-50]="result.win"
            [class.border-green-300]="result.win"
            [class.bg-red-50]="!result.win"
            [class.border-red-300]="!result.win"
          >
            <h2 class="text-3xl font-bold"
              [class.text-green-700]="result.win"
              [class.text-red-700]="!result.win"
            >
              {{ result.win ? 'ðŸŽ‰ You Win!' : 'ðŸ˜ž You Lose' }}
            </h2>
            <p class="text-gray-600">
              {{ result.win ? 'All cards are in the correct order!' : 'The cards are not in the correct order.' }}
            </p>

            <!-- Rematch controls -->
            <div class="flex items-center gap-3 mt-2">
              @if (!gameState.playAgainSent()) {
                <button
                  (click)="playAgain()"
                  class="px-6 py-2 bg-blue-500 text-white rounded-md font-medium hover:bg-blue-600"
                >
                  Play Again
                </button>
              } @else {
                <span class="text-sm text-gray-500">Waiting for {{ gameState.partnerName() }}â€¦</span>
              }
              <button
                (click)="leaveGame()"
                class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md font-medium hover:bg-gray-300"
              >
                Leave
              </button>
            </div>
            @if (gameState.partnerWantsRematch() && !gameState.playAgainSent()) {
              <p class="text-sm text-blue-600 mt-1">{{ gameState.partnerName() }} wants to play again!</p>
            }
          </div>
        }

        <!-- Board (final state) -->
        <app-board
          [selectedCardIndex]="-1"
          [revealMode]="true"
        />
      </div>
    } @else {
      <div class="flex justify-center items-center min-h-[300px] border-2 border-dashed border-gray-300 rounded-lg">
        <div class="text-center">
          @if (partnerDisconnected()) {
            <p class="text-yellow-600 mb-2">{{ gameState.partnerName() }} disconnected</p>
          } @else {
            <p class="text-lg text-gray-700">
              <span class="font-semibold">{{ gameState.playerName() }}</span>
              <span class="text-gray-400 mx-2">&amp;</span>
              <span class="font-semibold">{{ gameState.partnerName() }}</span>
            </p>
            <p class="text-sm text-gray-400 mt-2">Game in progressâ€¦</p>
          }
        </div>
      </div>
    }
  }
</div>
